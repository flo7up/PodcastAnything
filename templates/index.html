<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Podcast Anything</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Updated to Font Awesome 6 for newer icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTTX9il3gAc5Em0pI5FdXLFou1xVVj3S1V0n9ODuZV5Yq88tJ0O3sR3Xqnz0P/O9gggYZj6X2g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Link to External CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

    <script>
        // Function to handle autosave
        function autoSaveText(field, textType) {
            clearTimeout(field.autosaveTimer);
            field.autosaveTimer = setTimeout(function() {
                var text = field.value;
                
                fetch('/autosave', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'text': text,
                        'text_type': textType  // Either 'extracted_text' or 'conversation'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log('Autosave successful');
                    } else {
                        console.error('Autosave failed:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Autosave error:', error);
                });
            }, 1000);  // Wait 1 second after the user stops typing before autosaving
        }

        document.addEventListener("DOMContentLoaded", function() {
            // Handle Upload PDF Form Submission
            // Handle Upload and Convert PDF Form Submission
            document.getElementById('uploadConvertPdfForm').addEventListener('submit', function(event) {
                event.preventDefault();
            
                var formData = new FormData();
                var pdfFile = document.getElementById('pdf_file').files[0];
                var useAzure = document.getElementById('use_azure_doc_intelligence').checked;
            
                formData.append('pdf_file', pdfFile);
                formData.append('use_azure_doc_intelligence', useAzure ? 'true' : 'false');
            
                // Disable the button and show the spinner (if spinner is added)
                var uploadConvertButton = document.getElementById('upload_convert_pdf');
                // var loadingUploadConvertSpinner = document.getElementById('loading_upload_convert_pdf');
                uploadConvertButton.disabled = true;
                // loadingUploadConvertSpinner.style.display = 'inline-block';
            
                fetch('/upload_and_convert_pdf', { // Updated endpoint
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Re-enable the button and hide the spinner
                    uploadConvertButton.disabled = false;
                    // loadingUploadConvertSpinner.style.display = 'none';
            
                    var messageDiv = document.getElementById('message');
                    if (data.status === 'success') {
                        document.getElementById('text_content').value = data.text_content;
                        messageDiv.innerHTML = `<p class="success">${data.message}</p>`;
                    } else {
                        messageDiv.innerHTML = `<p class="error">${data.message}</p>`;
                    }
                })
                .catch(error => {
                    // Re-enable the button and hide the spinner
                    uploadConvertButton.disabled = false;
                    // loadingUploadConvertSpinner.style.display = 'none';
                    console.error('Error:', error);
                    var messageDiv = document.getElementById('message');
                    messageDiv.innerHTML = `<p class="error">An error occurred while uploading and converting the PDF. Please try again.</p>`;
                });
            });

            // Handle Generate Outline Form Submission
            document.getElementById('outlineForm').addEventListener('submit', function(event) {
                event.preventDefault();

                var formData = new FormData();
                var textContent = document.getElementById('text_content').value;
                formData.append('text_content', textContent);

                document.getElementById('generate_outline').disabled = true;
                document.getElementById('loading').style.display = 'inline-block';

                fetch('/generate_outline', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('generate_outline').disabled = false;
                    document.getElementById('loading').style.display = 'none';
                    var messageDiv = document.getElementById('message');
                    if (data.status === 'success') {
                        document.getElementById('conversation_text').value = data.conversation;
                        messageDiv.innerHTML = `<p class="success">${data.message}</p>`;
                    } else {
                        messageDiv.innerHTML = `<p class="error">${data.message}</p>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('generate_outline').disabled = false;
                    document.getElementById('loading').style.display = 'none';
                });
            });

        // Handle Generate Podcast Audio Form Submission
        document.getElementById('generateAudioForm').addEventListener('submit', function(event) {
            event.preventDefault();

            var formData = new FormData();
            var speaker1Voice = document.getElementById('speaker1_voice').value;
            var speaker2Voice = document.getElementById('speaker2_voice').value;
            var conversationText = document.getElementById('conversation_text').value;

            formData.append('speaker1_voice', speaker1Voice);
            formData.append('speaker2_voice', speaker2Voice);
            formData.append('conversation_text', conversationText);

            var generateAudioButton = document.getElementById('generate_audio');
            var loadingAudioSpinner = document.getElementById('loading_audio');
            generateAudioButton.disabled = true;
            loadingAudioSpinner.style.display = 'inline-block';

            // Send the request along with the outline form data to the server
            fetch('/generate_audio', {
                method: 'POST',
                body: formData
            })

            .then(response => response.json())
            .then(data => {
                generateAudioButton.disabled = false;
                loadingAudioSpinner.style.display = 'none';

                var messageDiv = document.getElementById('message');
                if (data.status === 'success') {
                    var audioSection = document.getElementById('audioSection');
                    if (!audioSection) {
                        audioSection = document.createElement('div');
                        audioSection.id = 'audioSection';
                        audioSection.className = 'audio-section';
                        document.querySelector('.container').appendChild(audioSection);
                    }
                    audioSection.innerHTML = `
                        <h2>Your Podcast is Ready!</h2>
                            <p>Use the microphone button to ask additional questions</p>
                            <div class="audio-horizontal-divider"> 
                                <audio controls id="podcastAudio">
                                    <source src="/static/${data.audio_file}?t=${Date.now()}" type="audio/mpeg">
                                    Your browser does not support the audio element.
                                </audio>
                                <div class="microphone-container">
                                    <button id="microphoneButton">
                                        <img src="{{ url_for('static', filename='images/microphone.png') }}" alt="Microphone Icon">
                                    </button>
                                </div>
                            <div 
                            <a href="/static/${data.audio_file}" download>Download</a>
                    `;
                    messageDiv.innerHTML = `<p class="success">${data.message}</p>`;

                    // After adding the new audioSection with microphoneButton, attach the event listeners
                    attachAudioManagement();
                } else {
                    messageDiv.innerHTML = `<p class="error">${data.message}</p>`;
                }
            })
            .catch(error => console.error('Error:', error));
        });

            // Handle Extract Website Form Submission
            document.getElementById('extractWebsiteForm').addEventListener('submit', function(event) {
                event.preventDefault();

                var formData = new FormData();
                var websiteUrl = document.getElementById('website_url').value;
                formData.append('website_url', websiteUrl);

                fetch('/extract_website', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    var messageDiv = document.getElementById('message');
                    if (data.status === 'success') {
                        document.getElementById('text_content').value = data.text_content;
                        messageDiv.innerHTML = `<p class="success">${data.message}</p>`;
                    } else {
                        messageDiv.innerHTML = `<p class="error">${data.message}</p>`;
                    }
                })
                .catch(error => console.error('Error:', error));
            });

            // Autosave event listeners
            var textContentField = document.getElementById('text_content');
            var conversationTextField = document.getElementById('conversation_text');
            
            textContentField.addEventListener('input', function() {
                autoSaveText(this, 'extracted_text');
            });
            
            conversationTextField.addEventListener('input', function() {
                autoSaveText(this, 'conversation');
            });

            // Function to attach audio management handlers (microphone click, etc.)
            function attachAudioManagement() {
                const microphoneButton = document.getElementById("microphoneButton");
                if (!microphoneButton) {
                    console.warn("No microphoneButton found.");
                    return;
                }
                const podcastAudio = document.getElementById("podcastAudio");

                // Variables to manage audio state
                let isPodcastPlaying = false;
                let isAnswerPlaying = false;
                let audioQueue = [];
                let currentAnswerAudio = null;
                let isFragmentPlaying = false;

                if (podcastAudio) {
                    // Track podcast playback state
                    podcastAudio.addEventListener('play', function() {
                        isPodcastPlaying = true;
                    });

                    podcastAudio.addEventListener('pause', function() {
                        isPodcastPlaying = false;
                    });

                    podcastAudio.addEventListener('ended', function() {
                        isPodcastPlaying = false;
                    });
                }

                microphoneButton.addEventListener("click", function () {
                    if (!podcastAudio) {
                        console.warn("No podcastAudio element found.");
                        return;
                    }
                
                    // Remember if the podcast was playing
                    let wasPodcastPlaying = !podcastAudio.paused;
                
                    // Stop the podcast
                    if (wasPodcastPlaying) {
                        podcastAudio.pause();
                    }
                
                    // Start recording the user's question
                    startRecording();
                
                    // Store whether the podcast was playing, so we can resume it later
                    isPodcastPlaying = wasPodcastPlaying;
                });

                let mediaRecorder;
                let audioChunks = [];

                function startRecording() {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            mediaRecorder = new MediaRecorder(stream);
                            mediaRecorder.start();

                            // Indicate recording has started (change button appearance, etc.)
                            console.log("Recording started...");

                            mediaRecorder.ondataavailable = function (e) {
                                audioChunks.push(e.data);
                            };

                            mediaRecorder.onstop = function () {
                                const audioBlob = new Blob(audioChunks, { 'type': 'audio/wav; codecs=opus' });
                                audioChunks = [];

                                // Send the audioBlob to the server
                                sendAudioToServer(audioBlob);
                            };

                            // Stop recording after a set time or on user action
                            setTimeout(() => {
                                mediaRecorder.stop();
                                console.log("Recording stopped.");
                            }, 5000); // Record for 5 seconds or implement manual stop
                        })
                        .catch(error => {
                            console.error('Error accessing microphone:', error);
                        });
                }

                function sendAudioToServer(audioBlob) {
                    const formData = new FormData();
                    formData.append('audio_data', audioBlob);
                    formData.append('text_content', document.getElementById('text_content').value);
                    formData.append('speaker1_voice', document.getElementById('speaker1_voice').value);
                
                    // Send the audioBlob to the server to process the question
                    fetch('/process_question', {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.blob();
                    })
                    .then(audioBlob => {
                        // Create a blob URL and play the audio
                        const audioURL = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioURL);
                        audio.play();
                        audio.onended = function() {
                            URL.revokeObjectURL(audioURL);
                
                            // Resume the podcast if it was playing before
                            if (isPodcastPlaying && podcastAudio.paused) {
                                podcastAudio.play()
                                    .then(() => {
                                        console.log("Podcast resumed.");
                                    })
                                    .catch(error => {
                                        console.error('Error resuming podcast:', error);
                                    });
                            }
                        };
                        audio.onerror = function(e) {
                            console.error('Audio playback error:', e);
                            URL.revokeObjectURL(audioURL);
                        };
                    })
                    .catch(error => {
                        console.error('Error receiving audio:', error);
                    });
                }
                

                // Queue to manage audio playback
                function playAudioFragment(audioBlob) {
                    console.log(`Received audio fragment: ${audioBlob.size} bytes`);
                
                    if (audioBlob.size === 0) {
                        console.error('Received empty audio fragment.');
                        return;
                    }
                
                    // Log the queue size before adding a new fragment
                    console.log(`Queue size before adding fragment: ${audioQueue.length}`);
                
                    // Add the new fragment to the queue
                    audioQueue.push(audioBlob);
                
                    // Log the queue size after adding the fragment
                    console.log(`Queue size after adding fragment: ${audioQueue.length}`);
                
                    // If no fragment is currently playing, start playback
                    if (!isFragmentPlaying) {
                        playNextAudio();
                    }
                }

                function playNextAudio() {
                    if (audioQueue.length > 0 && !isFragmentPlaying) {
                        isFragmentPlaying = true;  // Mark fragment as playing
                        
                        const blob = audioQueue.shift();
                        const audioURL = URL.createObjectURL(blob);
                        const audio = new Audio(audioURL);

                        currentAnswerAudio = audio; // Keep reference to the current audio

                        audio.onended = function () {
                            URL.revokeObjectURL(audioURL);
                            isFragmentPlaying = false;
                            playNextAudio();
                        };

                        audio.onerror = function (e) {
                            console.error('Audio playback error:', e);
                            URL.revokeObjectURL(audioURL);
                            isFragmentPlaying = false;  // Mark fragment as finished in case of error
                            playNextAudio();  // Attempt to play the next fragment
                        };

                        audio.play()
                            .then(() => {
                                console.log("Playing answer fragment.");
                            })
                            .catch(error => {
                                console.error('Error playing audio fragment:', error);
                                isFragmentPlaying = false;  // Reset flag if playback fails
                                playNextAudio(); // Attempt to play the next fragment
                            });
                    } else {
                        // Answer audio has finished playing
                        isAnswerPlaying = false;
                        isFragmentPlaying = false;

                        // Resume podcast if it was playing before
                        if (isPodcastPlaying && podcastAudio.paused) {
                            podcastAudio.play()
                                .then(() => {
                                    console.log("Podcast resumed.");
                                })
                                .catch(error => {
                                    console.error('Error resuming podcast:', error);
                                });
                        }
                    }
                }
            }

            document.querySelectorAll('.play-voice-sample').forEach(function(button) {
                button.addEventListener('click', function() {
                    var voiceInputId = this.getAttribute('data-voice-input-id');
                    var voiceSelect = document.getElementById(voiceInputId);
                    var voiceName = voiceSelect.value;
        
                    // Send request to get voice sample
                    fetch('/get_voice_sample', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({'voice_name': voiceName})
                    })
                    .then(response => response.arrayBuffer())
                    .then(buffer => {
                        const audioBlob = new Blob([buffer], { type: 'audio/wav' });
                        const audioURL = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioURL);
                        audio.play();
                        audio.onended = function() {
                            URL.revokeObjectURL(audioURL);
                        };
                    })
                    .catch(error => {
                        console.error('Error fetching voice sample:', error);
                    });
                });
            });
            // Attach audio management if microphoneButton is present on load
            // This ensures that if the audioSection is already present when the page loads, the event listeners are attached
            attachAudioManagement();
        });
    </script>

       <!-- Link to External CSS (Optional) -->
       <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    </head>
    <body>
        <div class="container">
            <!-- Logo and Title -->
            <div class="logo-container">
                <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Podcast Anything Logo">
                <h1>Podcast Anything</h1>
            </div>
    
            <!-- Message Div for displaying messages -->
            <div id="message"></div>
    
            <!-- Podcast Content Section -->
            <section>
                <h2><i class="fas fa-microphone-alt"></i> Podcast Content</h2>
                <p>Generate a podcast outline from a PDF, website content, or paste the content into the text field below.</p>
                <div class="options-container">
                    <!-- Option 1: Upload PDF -->
                    <div class="option">
                        <form id="uploadConvertPdfForm" enctype="multipart/form-data">
                            <div class="form-group">
                                <label for="pdf_file"><i class="fas fa-file-pdf"></i> Select PDF File</label>
                                <input type="file" name="pdf_file" id="pdf_file" accept=".pdf" required>
                            </div>
                            <div class="form-group checkbox-group">
                                <input type="checkbox" name="use_azure_doc_intelligence" id="use_azure_doc_intelligence" checked>
                                <label for="use_azure_doc_intelligence">Use Azure Document Intelligence</label>
                            </div>
                            <div class="buttons">
                                <button type="submit" id="upload_convert_pdf">
                                    <i class="fas fa-file-upload"></i> Extract Text from PDF
                                </button>
                            </div>
                        </form>
                    </div>
    
                    <!-- Divider -->
                    <div class="option-divider">
                        <h2>Or</h2>
                    </div>
    
                    <!-- Option 2: Extract Text from Website -->
                    <div class="option">
                        <form id="extractWebsiteForm">
                            <div class="form-group">
                                <label for="website_url"><i class="fas fa-globe"></i> Website URL</label>
                                <input type="url" name="website_url" id="website_url" placeholder="Enter website URL..." required>
                            </div>
                            <div class="buttons">
                                <button type="submit" id="extract_website_text">
                                    <i class="fas fa-file-import"></i> Extract Text from Website
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
    
            <!-- Content for Generating Podcast Outline -->
            <section>
                <form id="outlineForm">
                    <div class="form-group">
                        <label for="text_content"><i class="fas fa-align-left"></i> Content for Podcast Outline</label>
                        <textarea name="text_content" id="text_content" rows="10" required>{{ text_content }}</textarea>
                    </div>
                    <div class="buttons">
                        <button type="submit" id="generate_outline">
                            <i class="fas fa-list-alt"></i> Generate Outline
                        </button>
                        <!-- Loading spinner -->
                        <div id="loading"></div>
                    </div>
                </form>
            </section>
    
            <!-- Podcast Outline Section -->
            <section>
                <h2><i class="fas fa-podcast"></i> Podcast Outline</h2>
                <p>Select speaker voices and generate an audio podcast from the conversation outline below.</p>
                <form id="generateAudioForm">
                    <div class="voice-selection">
                        <div class="voice-selector">
                            <label for="speaker1_voice"><i class="fas fa-user"></i> Speaker 1 Voice</label>
                            <div class="voice-selection-container">
                                <select name="speaker1_voice" id="speaker1_voice" required>
                                    {% for voice in available_voices %}
                                        <option value="{{ voice.name }}" {% if voice.name == selected_voice1 %}selected{% endif %}>
                                            {{ voice.display_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="play-voice-sample" data-voice-input-id="speaker1_voice" title="Play Sample">
                                    <i class="fas fa-play-circle"></i>
                                </button>
                            </div>
                        </div>
    
                        <div class="voice-selector">
                            <label for="speaker2_voice"><i class="fas fa-user"></i> Speaker 2 Voice</label>
                            <div class="voice-selection-container">
                                <select name="speaker2_voice" id="speaker2_voice" required>
                                    {% for voice in available_voices %}
                                        <option value="{{ voice.name }}" {% if voice.name == selected_voice2 %}selected{% endif %}>
                                            {{ voice.display_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="play-voice-sample" data-voice-input-id="speaker2_voice" title="Play Sample">
                                    <i class="fas fa-play-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
    
                    <div class="form-group">
                        <label for="conversation_text"><i class="fas fa-comments"></i> Conversation Outline</label>
                        <textarea name="conversation_text" id="conversation_text" rows="20" placeholder="The generated conversation outline will appear here..." required>{{ conversation }}</textarea>
                    </div>
    
                    <div class="buttons">
                        <button type="submit" id="generate_audio">
                            <i class="fas fa-music"></i> Generate Audio
                        </button>
                        <!-- Audio Spinner -->
                        <div id="loading_audio"></div>
                    </div>
                </form>
            </section>
    
            <!-- Audio Output Section -->
            {% if audio_file %}
            <section class="audio-section" id="audioSection">
                <h2><i class="fas fa-headphones"></i> Your Podcast is Ready!</h2>
                <p>Use the microphone button to ask additional questions.</p>
                <div class="audio-horizontal-divider">
                    <audio controls id="podcastAudio">
                        <source src="{{ url_for('static', filename=audio_file.split('/')[-1]) }}" type="audio/wav">
                        Your browser does not support the audio element.
                    </audio>
                    <div class="microphone-container">
                        <button id="microphoneButton" title="Ask a Question">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
                <a href="{{ url_for('static', filename=audio_file.split('/')[-1]) }}" download>
                    <i class="fas fa-download"></i> Download
                </a>
            </section>
            {% endif %}
        </div>
    </body>
    </html>
