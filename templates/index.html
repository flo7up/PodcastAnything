<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Podcast Anything</title>
    
    <style>
        /* Spinner Styles */
        #loading {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: none; /* Hidden by default */
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Center the logo */
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }

        /* Align the two options horizontally */
        .options-container {
            display: flex;
            justify-content: space-between;
        }

        .option {
            flex: 1;
            margin-right: 10px;
        }
        
        .option:last-child {
            margin-right: 0; /* Remove margin for the last option */
        }
        
        /* Additional Styling for Better Presentation */
        .container {
            width: 80%;
            margin: auto;
            padding: 20px;
        }
        
        .buttons {
            margin-top: 10px;
        }
        
        .buttons input[type="submit"] {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .buttons input[type="submit"]:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .error {
            color: red;
            font-weight: bold;
        }
        
        .audio-section {
            margin-top: 20px;
        }
    </style>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // Function to handle autosave
        function autoSaveText(field, textType) {
            clearTimeout(window.autosaveTimer);
            window.autosaveTimer = setTimeout(function() {
                // Get the value from the field
                var text = $(field).val();
                
                // Send an AJAX request to the server
                $.ajax({
                    url: '/autosave',  // The new route in Flask
                    type: 'POST',
                    data: {
                        'text': text,
                        'text_type': textType  // Either 'extracted_text' or 'conversation'
                    },
                    success: function(response) {
                        console.log('Autosave successful');
                    },
                    error: function() {
                        console.log('Autosave failed');
                    }
                });
            }, 1000);  // Wait 1 second after the user stops typing before autosaving
        }

        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById('outlineForm');
            const generateButton = document.getElementById('generate_outline');
            const loadingSpinner = document.getElementById('loading');
        
            // Handle form submission to show spinner
            form.addEventListener('submit', function(event) {
                // Disable the button and show the spinner
                generateButton.disabled = true;
                loadingSpinner.style.display = 'inline-block';
        
                // Optionally, re-enable the button and hide spinner after form submission
                // This can be handled on the server response
            });
        
            // Attach the event handlers for autosave
            $('#text_content').on('input', function() {
                autoSaveText(this, 'extracted_text');
            });
        
            $('#conversation_text').on('input', function() {
                autoSaveText(this, 'conversation');
            });
        });
        
    </script>

    <!-- Link to External CSS (Optional) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>Podcast Anything</h1>

        <!-- Centered logo -->
        <div class="logo-container">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Podcast Anything Logo" style="width: 100px; height: 100px;">
        </div>
        
        <div class="options-container">
            <!-- Option 1: Upload PDF -->
            <div class="option">
                <h2>Option 1: Upload PDF</h2>
                
                <!-- Form to Upload PDF -->
                <form action="/" method="post" enctype="multipart/form-data">
                    <input type="hidden" name="action" value="upload_pdf">
                    
                    <label for="pdf_file">Select PDF to Upload:</label><br>
                    <input type="file" name="pdf_file" id="pdf_file" accept=".pdf" required><br><br>
                    <div class="buttons">
                        <input type="submit" name="upload_pdf" id="upload_pdf" value="Upload PDF">
                    </div>
                </form>
                
                <!-- Form to Convert PDF to Text -->
                <form action="/" method="post">
                    <input type="hidden" name="action" value="convert_pdf">
                    
                    <label for="use_azure_doc_intelligence">
                        <input type="checkbox" name="use_azure_doc_intelligence" id="use_azure_doc_intelligence" checked>
                        Use Azure Document Intelligence
                    </label><br><br>
                    <div class="buttons">
                        <input type="submit" name="convert_pdf" id="convert_pdf" value="Convert PDF to Text">
                    </div>
                </form>
            </div>
    
            <!-- Option 2: Extract Text from Website -->
            <div class="option">
                <h2>Option 2: Extract Text from Website</h2>
                
                <!-- Form to Extract Text from Website -->
                <form action="/" method="post">
                    <input type="hidden" name="action" value="extract_website">
                    
                    <input type="url" name="website_url" placeholder="Enter website URL here..." required><br><br>
                    <div class="buttons">
                        <input type="submit" name="extract_website" id="extract_website_text" value="Extract Text from Website">
                    </div>
                </form>
            </div>
        </div>
    
        <!-- Generate Podcast Outline Section -->
        <h2>Generate Podcast Outline</h2>
        <form action="/" method="post" id="outlineForm">
            <input type="hidden" name="action" value="generate_outline">
            
            <label for="text_content">Enter or Edit Extracted Text:</label><br>
            <textarea name="text_content" id="text_content" rows="10" required>{{ text_content }}</textarea><br>
            <div class="buttons">
                <input type="submit" id="generate_outline" value="Generate Outline">
                <!-- Loading spinner -->
                <div id="loading"></div>
            </div>
        </form>
        
        <!-- Step 4: Generate Audio Podcast -->
        <h2>Generate Audio Podcast</h2>
        <form action="/" method="post" id="generateAudioForm">
            <input type="hidden" name="action" value="generate_audio">
            
            <div class="form-group mt-4 voice-selection">
                <label>Select Voices for Speakers:</label>
                <div class="voice-selectors">
                    <div class="voice-selector">
                        <label for="speaker1_voice">Speaker 1:</label>
                        <select name="speaker1_voice" id="speaker1_voice" class="form-control" required>
                            {% for voice in available_voices %}
                                <option value="{{ voice.name }}"
                                    {% if voice.name == selected_voice1 %}
                                        selected
                                    {% endif %}
                                >{{ voice.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
            
                    <div class="voice-selector">
                        <label for="speaker2_voice">Speaker 2:</label>
                        <select name="speaker2_voice" id="speaker2_voice" class="form-control" required>
                            {% for voice in available_voices %}
                                <option value="{{ voice.name }}"
                                    {% if voice.name == selected_voice2 %}
                                        selected
                                    {% endif %}
                                >{{ voice.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <br>
            <label for="conversation_text">Review/Edit Conversation Outline:</label><br>
            <textarea name="conversation_text" id="conversation_text" rows="20" placeholder="The generated conversation outline will appear here..." required>{{ conversation }}</textarea><br>
            <div class="buttons">
                <input type="submit" name="generate_audio" id="generate_audio" value="Generate Audio">
            </div>
        </form>

        <!-- Display Error Messages -->
        {% if error %}
            <p class="error">{{ error }}</p>
        {% endif %}

        <!-- Audio Output Section -->
        {% if audio_file %}
            <div class="audio-section">
                <h2>Your Podcast is Ready!</h2>
                <audio controls>
                    <source src="{{ url_for('static', filename=audio_file.split('/')[-1]) }}" type="audio/wav">
                    Your browser does not support the audio element.
                </audio>
                <br>
                <a href="{{ url_for('static', filename=audio_file.split('/')[-1]) }}" download>Download Podcast</a>
            </div>
        {% endif %}
    </div>
</body>
</html>
